var app={recaptcha:{fields:[],onloadCallback:function(){console.log("app. grecaptcha is ready!");for(var i=0,fieldsLength=this.fields.length;i<fieldsLength;i++)this.initField(this.fields[i])},initField:function(field){field.verifyCallback=function(response){console.log("app. recaptcha response = "+response);field.value=response};field.expiredCallback=function(response){console.log("app. recaptcha expired");field.value=null};field.value_id=grecaptcha.render(document.getElementById(field.id),{"sitekey":field.value,
"theme":"light","callback":field.verifyCallback,"expired-callback":field.expiredCallback})}}};var containers={};var entities={};
$(document).ready(function(){$.notifyDefaults({type:"danger",icon:"glyphicon glyphicon-star",icon_type:"class",allow_dismiss:true,newest_on_top:true,delay:5E3,z_index:2031,placement:{from:"top",align:"center"}});if(typeof descriptor!="undefined"){console.log(descriptor);app.descriptor=descriptor;if(descriptor.type=="entity"){var entity=saveFullServerEntity(descriptor);initEntityScrollers(entity);var renderData=renderEntity(entity);renderData.dfd.done(function(data){var container_id=renderData.container_id;
renderEntityScrollers(entity);initEntityScripts(container_id)})}else if(descriptor.type=="scroller"){initScroller(descriptor);saveScrollerItems(descriptor);var renderData=renderScroller(descriptor,true)}}if(typeof Dropzone!="undefined")Dropzone.autoDiscover=false});function initEntityScrollers(descriptor){for(var key in descriptor.scrollers)initScroller(descriptor.scrollers[key])}
function initScroller(descriptor){if(!descriptor.local_data){descriptor.local_data={udid:createID()};createUDID(descriptor)}saveCustomTemplate(descriptor)}
function renderEntity(descriptor){var container_id=descriptor.local_data.container_id;if(!containers[container_id])containers[container_id]={jqobj:$("#entity_form_placeholder"),data:descriptor};return{dfd:$.when(getTemplate(descriptor)).done(function(data){var html=data.tmpl.render({descriptor:descriptor});containers[container_id].jqobj.html(html)}),container_id:container_id}}
function renderEntityScrollers(descriptor){var dfd,key;for(key in descriptor.scrollers){dfd=renderScroller(descriptor.scrollers[key],false);dfd.done(function(data){containers[data.containerID].parent_container_id=descriptor.local_data.container_id})}}
function renderScroller(descriptor,isRoot){var container_id=descriptor.local_data.container_id,deferred=$.Deferred();$.when(getTemplate(descriptor)).done(function(data){var html=data.tmpl.render({descriptor:descriptor});if(!containers[container_id])if(isRoot)containers[container_id]={jqobj:$("#scroller_form_placeholder"),data:descriptor};else containers[container_id]={jqobj:$("#placeholder_"+container_id),data:descriptor};containers[container_id].jqobj.html(html);initScrollerScripts(container_id);
deferred.resolve({dfd:deferred,containerID:container_id})});return deferred.promise()}function saveScrollerItems(descriptor){if(descriptor.items){var itemsLength=descriptor.items.length;for(var i=0;i<itemsLength;i++)descriptor.items[i]=copyServerEntityDataToEntities(descriptor.items[i],descriptor.entityNameLC)}}
function saveFullServerEntity(descriptor){saveCustomTemplate(descriptor);var localEntity=copyServerEntityDataToEntities(descriptor);if(localEntity.scrollers)for(var key in localEntity.scrollers){var scroller=localEntity.scrollers[key];if(scroller.items){var len=scroller.items.length;for(var i=0;i<len;i++){scroller.items[i]=copyServerEntityDataToEntities(scroller.items[i],scroller.entityNameLC);if(scroller.relationType)scroller.items[i].local_data.relationType=scroller.relationType}}}return localEntity}
function copyServerEntityDataToEntities(descriptor,entityNameLC){if(!entityNameLC)entityNameLC=descriptor.entityNameLC;var eid;if(descriptor.fields.id.value=="-1")eid=createIDForNewEntities();else eid=descriptor.fields.id.value;if(!entities[entityNameLC])entities[entityNameLC]={};if(!entities[entityNameLC][eid])entities[entityNameLC][eid]={};if(!entities[entityNameLC][eid].local_data||entities[entityNameLC][eid].local_data&&entities[entityNameLC][eid].local_data.status!="edited"){copyDescriptor(descriptor,
entities[entityNameLC][eid]);if(!entities[entityNameLC][eid].local_data){entities[entityNameLC][eid].type="entity";entities[entityNameLC][eid].entityNameLC=entityNameLC;entities[entityNameLC][eid].controllerName=descriptor.controllerName;entities[entityNameLC][eid].local_data={status:"actual",udid:createID(),eid:eid};createUDID(entities[entityNameLC][eid])}else entities[entityNameLC][eid].local_data.status="actual"}return entities[entityNameLC][eid]}
function copyDescriptor(fromObj,toObj){if(fromObj.type=="scroller"){if(!toObj)toObj={};for(var key in fromObj)if(fromObj[key]==null)toObj[key]=null;else if(key=="local_data")continue;else if(typeof fromObj[key]=="object")if($.isArray(fromObj[key])){toObj[key]=[];var len=fromObj[key].length;for(var i=0;i<len;i++)toObj[key][i]=deepCopy(fromObj[key][i])}else toObj[key]=deepCopy(fromObj[key]);else toObj[key]=fromObj[key];return toObj}else{if(!toObj&&key!="fields")toObj={};for(var key in fromObj)if(fromObj[key]==
null)toObj[key]=null;else if(key=="scrollers"){if(!toObj.scrollers&&fromObj.scrollers)toObj.scrollers={};for(var key2 in fromObj.scrollers)toObj.scrollers[key2]=copyDescriptor(fromObj.scrollers[key2]);continue}else if(key=="local_data")continue;else if(key=="fields"&&toObj.fields)for(var key2 in fromObj.fields)if(toObj.fields[key2])toObj.fields[key2]=copyDescriptor(fromObj.fields[key2],toObj.fields[key2]);else toObj.fields[key2]=copyDescriptor(fromObj.fields[key2]);else if(typeof fromObj[key]=="object")if(1+
fromObj[key].length>=1){toObj[key]=[];var len=fromObj[key].length;for(var i=0;i<len;i++)if(typeof fromObj[key][i]=="object")toObj[key][i]=copyDescriptor(fromObj[key][i]);else toObj[key][i]=fromObj[key][i]}else toObj[key]=copyDescriptor(fromObj[key]);else toObj[key]=fromObj[key];initEntityScrollers(toObj)}return toObj}
function deepCopy(fromObj,toObj){if(!toObj)toObj={};if(typeof fromObj!="object")return fromObj;for(var key in fromObj)if(fromObj[key]==null)toObj[key]=null;else if(typeof fromObj[key]=="object")if($.isArray(fromObj[key])){toObj[key]=[];var len=fromObj[key].length;for(var i=0;i<len;i++)toObj[key][i]=deepCopy(fromObj[key][i])}else toObj[key]=deepCopy(fromObj[key]);else toObj[key]=fromObj[key];return toObj}function createID(){return Math.random()*1E18}
function createUDID(descriptor){if(descriptor){descriptor.local_data.container_id=descriptor.type+"_"+descriptor.controllerName+"_"+descriptor.local_data.udid;return descriptor.local_data.container_id}else return"temporary_"+createID()}function createIDForNewEntities(){return"_"+createID()}function getRootContainerId(container_id){if(containers[container_id].parent_container_id)return getRootContainerId(containers[container_id].parent_container_id);else return container_id}
function saveCustomTemplate(descriptor){if(descriptor.template){var tmplName=descriptor.controllerName+"_template";var tmpl=$.templates("#"+tmplName);if(!tmpl.tmplName)$("body").append(descriptor.template)}}
function getTemplateByName(tmplName){var deferred=$.Deferred();if(!$.templates[tmplName])$.get("/templates/"+tmplName+".html",function(data,textStatus,jqXHR){$.templates(tmplName,data)}).done(function(){deferred.resolve({tmplName:tmplName,tmpl:$.templates[tmplName]})}).fail(function(){deferred.reject()});else deferred.resolve({tmplName:tmplName,tmpl:$.templates[tmplName]});return deferred.promise()}
function getTemplate(descriptor){var deferred=$.Deferred();if(descriptor){var tmplName;if(descriptor.templateName){var tmpl=$.templates("#"+descriptor.templateName);if($.templates[descriptor.templateName])deferred.resolve({tmplName:descriptor.templateName,tmpl:$.templates[descriptor.templateName]});else if(tmpl.tmplName)deferred.resolve({tmplName:"#"+descriptor.templateName,tmpl:$.templates("#"+descriptor.templateName)});else $.get("/templates/"+descriptor.templateName+".html",function(data,textStatus,
jqXHR){$.templates(descriptor.templateName,data)}).done(function(){deferred.resolve({tmplName:descriptor.templateName,tmpl:$.templates[descriptor.templateName]})}).fail(function(){deferred.reject()})}else{if(descriptor.controllerNameLC.indexOf("list")>-1)tmplName="scroller_template";else tmplName="entity_template";var tmpl=$.templates("#"+tmplName);if($.templates[tmplName])deferred.resolve({tmplName:tmplName,tmpl:$.templates[tmplName]});else if(tmpl.tmplName)deferred.resolve({tmplName:"#"+tmplName,
tmpl:$.templates("#"+tmplName)});else $.get("/templates/"+tmplName+".html",function(data,textStatus,jqXHR){$.templates(tmplName,data)}).done(function(){deferred.resolve({tmplName:tmplName,tmpl:$.templates[tmplName]})}).fail(function(){deferred.reject()})}}else deferred.reject();return deferred.promise()}
app.getScript=function(url,async){var request=new XMLHttpRequest;request.open("GET",url,async);request.onload=function(e){if(request.readyState===4)if(request.status===200)console.log(request.responseText);else console.error(request.statusText)};request.onerror=function(e){console.error(request.statusText)};request.setRequestHeader("Access-Control-Allow-Origin","*");request.send(null)};
function link_entity(container_id,controllerName,field_id,select_style){var rq={page:1,sort:"id",order:"DESC",page_size:10};var container=containers[container_id];var url="/"+controllerName+"/index";rq.filter_active=1;for(var key in container.data.columns){var field=container.data.columns[key];if(field.filter_value&&field.filter_value!=null&&field.filter_value!="")rq["filter_"+field.id]=encodeURIComponent(field.filter_value)}if(container.data.type=="scroller"){var ids="";var len=container.data.items.length;
for(var i=0;i<len;i++)if(i==0)ids+=container.data.items[i].fields.id.value;else ids+=","+container.data.items[i].fields.id.value;if(container.data.local_data.added_items){len=container.data.local_data.added_items.length;for(var i=0;i<len;i++)if(i==0&&ids.length==0)ids+=container.data.local_data.added_items[i].fields.id.value;else ids+=","+container.data.local_data.added_items[i].fields.id.value}if(ids.length>0)rq.exclude_ids=ids}container.data.local_data.selectTarget={container_id:container.data.local_data.container_id,
field_id:field_id,select_style:select_style};console.log(url);$.ajax({url:url,dataType:"json",method:"post",data:JSON.stringify(rq),beforeSend:function(){},complete:function(){},success:function(json){console.log(json);if(!handleAjaxError(json.error)){var descriptor=copyDescriptor(json);initScroller(descriptor);descriptor.local_data.select_style=this.data.local_data.selectTarget.select_style;descriptor.edit_style="modal";saveScrollerItems(descriptor);var renderData=renderModal(descriptor,this);renderData.dfd.done(function(data){showModal(renderData.container_id)})}}.bind(container),
error:function(xhr,ajaxOptions,thrownError){console.log(thrownError+"\r\n"+xhr.statusText+"\r\n"+xhr.responseText)}})}function getEntity(entityNameLC,eid){return entities[entityNameLC][eid]}function getScroller(entityNameLC,eid,scrollerName){return entities[entityNameLC][eid][scrollers][scrollerName]}
function addItemToScroller(item,tScroller,opts){if(!opts)opts={confirmFromServer:null};var entity_id=item.local_data.eid;var isFound=false;var len;var i;if(tScroller.local_data.deleted_items){len=tScroller.local_data.deleted_items.length;for(i=0;i<len;i++)if(tScroller.local_data.deleted_items[i].local_data.eid==entity_id){tScroller.local_data.deleted_items.splice(i,1);tScroller.items.push(item);isFound=true;break}}if(tScroller.local_data.added_items&&!isFound){len=tScroller.local_data.added_items.length;
for(i=0;i<len;i++)if(tScroller.local_data.added_items[i].local_data.eid==entity_id){if(opts.confirmFromServer){tScroller.local_data.added_items.splice(i,1);tScroller.items.push(item)}isFound=true;break}}if(tScroller.items&&!isFound){len=tScroller.items.length;for(i=0;i<len;i++)if(tScroller.items[i].local_data.eid==entity_id){isFound=true;break}}if(!isFound)if(opts.confirmFromServer)tScroller.items.unshift(item);else{if(!tScroller.local_data.added_items)tScroller.local_data.added_items=[];tScroller.local_data.added_items.push(item)}}
function deleteItemFromScroller(item,tScroller,opts){if(!opts)opts={confirmFromServer:null};var entity_id=item.local_data.eid;var isFound=false;var len;var i;if(tScroller.local_data.deleted_items){len=tScroller.local_data.deleted_items.length;for(i=0;i<len;i++)if(tScroller.local_data.deleted_items[i].local_data.eid==entity_id){if(opts.confirmFromServer)tScroller.local_data.deleted_items.splice(i,1);isFound=true;break}}if(tScroller.local_data.added_items&&!isFound){len=tScroller.local_data.added_items.length;
for(i=0;i<len;i++)if(tScroller.local_data.added_items[i].local_data.eid==entity_id){tScroller.local_data.added_items.splice(i,1);isFound=true;break}}if(tScroller.items&&!isFound){len=tScroller.items.length;for(i=0;i<len;i++)if(tScroller.items[i].local_data.eid==entity_id){tScroller.items.splice(i,1);if(!opts.confirmFromServer){if(!tScroller.local_data.deleted_items)tScroller.local_data.deleted_items=[];tScroller.local_data.deleted_items.push(item)}isFound=true;break}}}
function saveCustomTemplate(descriptor){if(descriptor.template){var tmplName=descriptor.controllerName+"_template";var tmpl=$.templates("#"+tmplName);if(!tmpl.tmplName)$("body").append(descriptor.template)}}
function initEntityScripts(container_id){var container=containers[container_id];var entity=container.data;for(var fieldID in entity.fields){var field=entity.fields[fieldID];if(field.type=="img"){if(entity.actionName=="edit"&&field["access"]=="edit"){if(!entity.local_data.fields)entity.local_data.fields={};if(!entity.local_data.fields[fieldID])entity.local_data.fields[fieldID]={};entity.local_data.fields[fieldID].deferredUpload=$.Deferred();entity.local_data.fields[fieldID].deferredDelete=$.Deferred();
entity.local_data.fields[fieldID].deferredUpload.done(function(){deleteEntityFiles(entity,fieldID)});var opts={action:"/file/upload",url:"/file/upload",maxFiles:field.max_count?field.max_count:1,acceptedFiles:"image/*",thumbnailWidth:500,thumbnailHeight:300,previewsContainer:"#field_"+fieldID+"_"+entity.fields.id.value+"_preview",maxFilesize:2,clickable:"#field_"+fieldID+"_"+entity.fields.id.value+", "+"#field_"+fieldID+"_"+entity.fields.id.value+"_addbutton",autoProcessQueue:false,uploadMultiple:true,
dictDefaultMessage:"\u041f\u0435\u0440\u0435\u0442\u0430\u0449\u0438\u0442\u0435 \u0444\u0430\u0439\u043b\u044b \u0432 \u0434\u0430\u043d\u043d\u0443\u044e \u043e\u0431\u043b\u0430\u0441\u0442\u044c \u0438\u043b\u0438 \u043a\u043b\u0438\u043a\u043d\u0438\u0442\u0435 \u0434\u043b\u044f \u0432\u044b\u0431\u043e\u0440\u0430 \u0444\u0430\u0439\u043b\u043e\u0432",dictFallbackMessage:"\u0412\u0430\u0448 \u0431\u0440\u0430\u0443\u0437\u0435\u0440 \u043d\u0435 \u043f\u043e\u0434\u0434\u0435\u0440\u0436\u0438\u0432\u0430\u0435\u0442 \u0437\u0430\u0433\u0440\u0443\u0437\u043a\u0443 \u0444\u0430\u0439\u043b\u043e\u0432 \u043c\u0435\u0442\u043e\u0434\u043e\u043c \u043f\u0435\u0440\u0435\u0442\u0430\u0441\u043a\u0438\u0432\u0430\u043d\u0438\u044f",
dictFallbackText:"\u041f\u043e\u0436\u0430\u043b\u0443\u0439\u0441\u0442\u0430, \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u0443\u0439\u0442\u0435 \u0441\u0442\u0430\u043d\u0434\u0430\u0440\u0442\u043d\u0443\u044e \u0444\u043e\u0440\u043c\u0443 \u0434\u043b\u044f \u0437\u0430\u0433\u0440\u0443\u0437\u043a\u0438 \u0444\u0430\u0439\u043b\u043e\u0432, \u043a\u0430\u043a \u0432 \u0441\u0442\u0430\u0440\u044b\u0435 \u0434\u043e\u0431\u0440\u044b\u0435 \u0432\u0440\u0435\u043c\u0435\u043d\u0430",dictInvalidFileType:"\u041d\u0435 \u043f\u043e\u0434\u0434\u0435\u0440\u0436\u0438\u0432\u0430\u0435\u043c\u044b\u0439 \u0442\u0438\u043f \u0444\u0430\u0439\u043b\u0430",
dictFileTooBig:"\u0424\u0430\u0439\u043b \u0438\u043c\u0435\u0435\u0442 \u0440\u0430\u0437\u043c\u0435\u0440: {{filesize}}. \u041c\u0430\u043a\u0441\u0438\u043c\u0430\u043b\u044c\u043d\u043e \u0434\u043e\u043f\u0443\u0441\u0442\u0438\u043c\u044b\u0439 \u0440\u0430\u0437\u043c\u0435\u0440: {{maxFilesize}}",dictRemoveFile:"\u0423\u0434\u0430\u043b\u0438\u0442\u044c",dictMaxFilesExceeded:"\u0412\u044b\u0431\u0440\u0430\u043d\u043e \u043c\u0430\u043a\u0441\u0438\u043c\u0430\u043b\u044c\u043d\u043e\u0435 \u043a\u043e\u043b\u0438\u0447\u0435\u0441\u0442\u0432\u043e \u0444\u0430\u043b\u043e\u0432",
previewTemplate:'<div class="dz-preview dz-file-preview col-lg-3"><p><img data-dz-thumbnail class="img-thumbnail center-block"/></p><p class="text-center"><button data-dz-remove class="btn btn-danger delete btn-xs"><i class="glyphicon glyphicon-trash"></i><span> \u0423\u0434\u0430\u043b\u0438\u0442\u044c</span></button></p><div class="bg-danger"><span data-dz-errormessage></span></div></div>'};var myDropzone=new Dropzone("#field_"+fieldID+"_"+entity.fields.id.value,opts);myDropzone.on("processing",
function(file){this.options.params.parent_entity_id=entity.local_data.eid;this.options.params.parent_entity_name=entity.entityName;this.options.params.parent_entity_field=fieldID});myDropzone.on("removedfile",function(file){var serverFlesCount=0;var deletedFilesCount=0;var dropzoneFilesCount=this.files.length;console.log("removedfile: id = "+file.id);if(entity.fields[fieldID].files&&entity.fields[fieldID].files.length>0){if(!entity.local_data.fields[fieldID].deletedFiles)entity.local_data.fields[fieldID].deletedFiles=
[];if(file.id)entity.local_data.fields[fieldID].deletedFiles.push(file.id);deletedFilesCount=entity.local_data.fields[fieldID].deletedFiles.length}if(field.files)serverFlesCount=field.files.length;var finalFilesCount=serverFlesCount-deletedFilesCount+dropzoneFilesCount;var clickableElementsLength=this.clickableElements.length;if(clickableElementsLength>0&&finalFilesCount<this.options.maxFiles)for(var i=0;i<clickableElementsLength;i++)this.clickableElements[i].style.display="flex";else for(var i=0;i<
clickableElementsLength;i++)this.clickableElements[0].style.display="none"});myDropzone.on("maxfilesreached",function(file){if(this.clickableElements.length>0)this.clickableElements[0].style.display="none"});myDropzone.on("completemultiple",function(files){var response=null;var filesLength=files.length;if(filesLength>0&&files[0].xhr){response=JSON.parse(files[0].xhr.response);console.log(response);if(!response.error){if(!entity.fields[fieldID].files)entity.fields[fieldID].files=[];for(var i=0;i<filesLength;i++){var file=
files[i];entity.fields[fieldID].files.push({id:file.id,name:file.name,url:file.url})}}else console.log(response.error)}if(this.getQueuedFiles().length==0)entity.local_data.fields[fieldID].deferredUpload.resolve()});if(entity.fields[fieldID].files){var files=entity.fields[fieldID].files;var filesLength=files.length;for(var i=0;i<filesLength;i++){var file=files[i];var mockFile={id:file.id,name:file.name,size:null,url:file.url};myDropzone.emit("addedfile",mockFile);myDropzone.createThumbnailFromUrl(mockFile,
file.url);myDropzone.emit("complete",mockFile)}if(myDropzone.clickableElements.length>0&&filesLength>=myDropzone.options.maxFiles)myDropzone.clickableElements[0].style.display="none";entity.local_data.fields[fieldID].deletedFiles=[]}if(!entity.local_data.fields)entity.local_data.fields={};if(!entity.local_data.fields[fieldID])entity.local_data.fields[fieldID]={};entity.local_data.fields[fieldID].uploader=myDropzone}}else if(field.type=="amount"){var jqField=container.jqobj.find("#field_"+fieldID+
"_value");jqField.keypress(function(e){var val=$(this).val();var pos=val.indexOf(".");if(e.which!==0&&(e.which<48&&e.which!==46||e.which>57))e.preventDefault();else if(e.which===46)if(val.indexOf(".")>-1)e.preventDefault();if(pos!=-1&&val.length-pos>2)val=val.slice(0,-1)}).blur(function(){var val=$(this).val();var pos=val.indexOf(".");if(pos!=-1&&val.length-pos>3)val=val.slice(0,-(val.length-pos-3));val=val.replace(/\s/g,"");$(this).val(val)})}else if(field.type=="recaptcha")if(grecaptcha)app.recaptcha.initField(field);
else app.recaptcha.fields.push(field)}}function onRecaptchaLoadCallback(){console.log("grecaptcha is ready!");app.recaptcha.onloadCallback()}
function handleAjaxError(error,container_id){if(error){var container;if(container_id)container=containers[container_id];var len=error.messages.length;for(var i=0;i<len;i++){var msg=error.messages[i];var title=msg.code?msg.code+". ":"";title+=msg.title?msg.title:"\u041e\u0448\u0438\u0431\u043a\u0430";$.notify({title:title,message:msg.msg},{type:"danger",icon:"glyphicon glyphicon-star"})}return true}return false}
function handleAjaxSuccess(success,container_id){var container;if(container_id)container=containers[container_id];if(success){var len=success.messages.length;var delay=1E4;for(var i=0;i<len;i++,delay+=delay){var msg=success.messages[i];var title=msg.code?msg.code+". ":"";title+=msg.title?msg.title:"\u041e\u043f\u0435\u0440\u0430\u0446\u0438\u044f \u0443\u0441\u043f\u0435\u0448\u043d\u0430";var n=$.notify({title:title,message:msg.msg},{type:"success",delay:delay})}return true}return false}
function confirmDelete(container,id){var def=$.Deferred();var selector="button[name='delete"+id+"']";var btn=container.jqobj.find(selector);if(btn.length==0&&container.parent_container_id)btn=containers[container.parent_container_id].jqobj.find(selector);if(btn.length==0&&!container.parent_container_id)btn=$(selector);if(btn.length==0)console.error("\u042d\u043b\u0435\u043c\u0435\u043d\u0442 \u043a\u043d\u043e\u043f\u043a\u0438 \u043d\u0435 \u043d\u0430\u0439\u0434\u0435\u043d \u0434\u043b\u044f \u0437\u0430\u043f\u0440\u043e\u0441\u0430 \u043f\u043e\u0434\u0442\u0432\u0435\u0440\u0436\u0434\u0435\u043d\u0438\u044f");
var options={placement:"top",title:"\u0423\u0434\u0430\u043b\u0438\u0442\u044c \u0431\u0435\u0437\u0432\u043e\u0437\u0432\u0440\u0430\u0442\u043d\u043e?",content:'<button type="button" class="btn btn-danger" aria-label="\u0414\u0430" name="yes" onclick="">\u0414\u0430 </button>&nbsp;<button type="button" class="btn btn-success" aria-label="\u041d\u0435\u0442" name="no" onclick="">\u041d\u0435\u0442</button>',html:true};btn.popover(options);btn.popover("show");var popover=btn.next();var content=popover.find("div.popover-content");
content.find("button[name='yes']").on("click",function(indx,element){def.resolve()});content.find("button").bind("click",function(indx,element){def.reject();btn.popover("destroy")});content.addClass("text-center");return def}
function checkPasswordStrength(ctrl,fieldID){var input=$(ctrl);var result=input.parent().parent().find("#pass_strength_result").hide();var val=ctrl.value;var strongRegex=new RegExp("^(?=.{8,})(?=.*[A-Z])(?=.*[a-z])(?=.*[0-9])(?=.*\\W).*$","g");var mediumRegex=new RegExp("^(?=.{7,})(((?=.*[A-Z])(?=.*[a-z]))|((?=.*[A-Z])(?=.*[0-9]))|((?=.*[a-z])(?=.*[0-9]))).*$","g");var enoughRegex=new RegExp("(?=.{6,}).*","g");var resultClass="";if(val&&val.length>0&&val.length<3){result.html("\u0441\u043b\u0438\u0448\u043a\u043e\u043c \u043a\u043e\u0440\u043e\u0442\u043a\u0438\u0439 \u043f\u0430\u0440\u043e\u043b\u044c");
resultClass=" label-danger"}else if(!val||val.length==0)result.html("");else if(false==enoughRegex.test(val)){result.html("\u0441\u043b\u0430\u0431\u044b\u0439 \u043f\u0430\u0440\u043e\u043b\u044c");resultClass=" label-default"}else if(strongRegex.test(val)){result.html("\u0445\u043e\u0440\u043e\u0448\u0438\u0439 \u043f\u0430\u0440\u043e\u043b\u044c");resultClass=" label-success"}else if(mediumRegex.test(val)){result.html("\u0441\u0440\u0435\u0434\u043d\u0438\u0439 \u043f\u0430\u0440\u043e\u043b\u044c");
resultClass=" label-info"}else{result.html("\u043e\u0447\u0435\u043d\u044c \u0441\u043b\u0430\u0431\u044b\u0439 \u043f\u0430\u0440\u043e\u043b\u044c");resultClass=" label-warning"}if(val&&val.length>0){result.removeClass();result.addClass("label"+resultClass);result.show()}checkPasswordEq(ctrl,fieldID)}
function togglePasswordMask(ctrl,fieldID){var toggleEl=$(ctrl);var inputEl=toggleEl.parent().parent().find("#"+fieldID);var inputType="password";if(inputEl.prop("type")=="password")inputType="text";toggleEl.find(".glyphicon").toggleClass("glyphicon-eye-open glyphicon-eye-close");inputEl.prop("type",inputType)}
function checkPasswordEq(ctrl,fieldID){var container=$(ctrl).parent().parent().parent();var input1=container.find("#"+fieldID);var input2=container.find("#password2");var val1=input1.val();var val2=input2.val();var result=container.find("#pass_eq_result");var input2Cont=input2.parent();var input2Addon=input2Cont.find(".input-group-addon");result.removeClass();result.hide();if(val1==""&&val2==""){input2Addon.html('<span class="glyphicon glyphicon-asterisk"></span>');input2Cont.removeClass("has-error");
input2Cont.removeClass("has-success");result.html("");return true}else if(val1===val2){input2Addon.html('<span class="glyphicon glyphicon-ok"></span>');input2Cont.removeClass("has-error");input2Cont.addClass("has-success");result.html("\u043f\u0430\u0440\u043e\u043b\u0438 \u0441\u043e\u0432\u043f\u0430\u0434\u0430\u044e\u0442");result.addClass("label label-success");result.show();return true}else{input2Addon.html('<span class="glyphicon glyphicon-remove"></span>');input2Cont.removeClass("has-success");
input2Cont.addClass("has-error");result.html("\u043f\u0430\u0440\u043e\u043b\u0438 \u043d\u0435 \u0441\u043e\u0432\u043f\u0430\u0434\u0430\u044e\u0442");result.addClass("label label-danger");result.show();return false}};/*
 json.checkResult || (json.checkResult && !checksHasError(json.checkResult))*/
function entitySave(container_id){var def=$.Deferred();if(container_id)$.when(entityCheck(container_id)).done(function(data){if(data.json.checkResult){showChecksModal(data);def.reject()}else $.when(checkedEntitySave(data.descriptor)).done(function(descriptor){def.resolve(descriptor)})});else{console.error("Function: entitySave. Parameter container_id not defined");def.reject()}return def}
function entitySend(container_id){if(container_id){var def=$.Deferred();$.when(entitySave(container_id)).done(function(descriptor){if(descriptor.local_data.status=="actual")alert("\u0421\u0443\u0449\u043d\u043e\u0441\u0442\u044c \u043e\u0442\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u0430");else alert("\u0421\u0443\u0449\u043d\u043e\u0441\u0442\u044c \u043d\u0435 \u043e\u0442\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u0430, \u0442.\u043a. \u043d\u0435 \u0441\u043e\u0445\u0440\u0430\u043d\u0435\u043d\u0430 \u043d\u0430 \u0441\u0435\u0440\u0432\u0435\u0440")})}else console.error("Function: entitySend. Parameter container_id not defined")}
function mandatorySave(container_id){if(container_id)$.when(entityCheck(container_id)).done(function(data){var hasErrors=false;if(!data.json.checkResult||data.json.checkResult&&!checksHasError(data.json.checkResult)){data.descriptor.local_data.mandatorySave=true;return checkedEntitySave(data.descriptor)}});else console.error("Function: mandatorySave. Parameter container_id not defined")}
function checksHasError(checkResult){if(checkResult){var checkResultLength=checkResult.length;for(var i=0;i<checkResultLength;i++)if(checkResult[i].type=="error")return true}return false}
function checkedEntitySave(descriptor){var deferreds=[];if(descriptor.scrollers)for(var key in descriptor.scrollers){var scroller=descriptor.scrollers[key];if(scroller.relationType=="n"){if(scroller.local_data.added_items){var len=scroller.local_data.added_items.length;for(var i=0;i<len;i++)deferreds.push(checkedEntitySave(scroller.local_data.added_items[i]))}var len=scroller.items.length;for(var i=0;i<len;i++)if(scroller.items[i].local_data.status=="edited")deferreds.push(checkedEntitySave(scroller.items[i]))}}var def=
$.Deferred();var res=$.when.apply($,deferreds);res.done(function(){if(descriptor.local_data.container_id)entitySaveToLocalFromHTML(descriptor.local_data.container_id);var needSave=false;if(descriptor.local_data.status=="edited")if(descriptor.local_data.relationType&&descriptor.local_data.relationType=="n"&&!descriptor.local_data.container_id||!(descriptor.local_data.relationType&&descriptor.local_data.relationType=="n")&&descriptor.local_data.container_id){needSave=true;$.when(entitySaveToServer(descriptor)).done(function(){descriptor.local_data.status=
"actual";def.resolve()})}if(!needSave)def.resolve(descriptor)});def.done(function(){if(descriptor.local_data.target_container_id){var tContainerData=containers[descriptor.local_data.target_container_id].data;var opts={confirmFromServer:descriptor.local_data.relationType&&descriptor.local_data.relationType=="n"||!descriptor.local_data.container_id?false:true};if(tContainerData.type=="scroller")addItemToScroller(descriptor,tContainerData,opts);renderScroller(tContainerData,false);hideModal(containers[descriptor.local_data.container_id].parent_container_id)}else if(descriptor.local_data.container_id&&
containers[descriptor.local_data.container_id].parent_container_id)hideModal(containers[descriptor.local_data.container_id].parent_container_id)});return def}function entityCheckOnly(container_id,item){$.when(entityCheck(container_id)).done(function(data){showChecksModal(data)})}
function showChecksModal(data){var modal_container_id="modal_checks";data.descriptor.checkResult=data.json.checkResult;var tmplLoader=getTemplateByName("ckecks_modal_template");tmplLoader.done(function(tmplLoader){var html=tmplLoader.tmpl.render({descriptor:data.descriptor,modal_container_id:modal_container_id});var modalsJQ=$("#container_modals");var mJQ=modalsJQ.find("#"+modal_container_id);if(mJQ.length>0)mJQ.replaceWith(html);else modalsJQ.append(html);containers[modal_container_id]={jqobj:modalsJQ.find("#"+
modal_container_id),data:data.descriptor};showModal(modal_container_id)})}
function entityCheck(container_id){var descriptor;var jqobj;var def=$.Deferred();if(container_id){descriptor=containers[container_id].data;jqobj=containers[container_id].jqobj}else return def.resolve();if(descriptor.fields){var field,field_jqobj,val,val_id;var tmpFields={};var error={messages:[]};var checkFields={};for(field_id in descriptor.fields){val=null,val1=null,val2=null;val_id=null;field=descriptor.fields[field_id];if(field.type!="label"&&field.id!="operations"&&field.access&&field.access==
"edit"){if(field.type=="text"||field.type=="textarea"||field.type=="number"||field.type=="email"||field.type=="password"||field.type=="date"||field.type=="amount"){field_jqobj=jqobj.find("#field_"+field.id+"_value");if(field_jqobj.length>0)val=field_jqobj.val();else val=null;if(field.type=="password"&&val!=null&&val!="")val=sha1(val)}else if(field.type=="period"){field_jqobj1=jqobj.find("#field_"+field.id+"_value1");field_jqobj2=jqobj.find("#field_"+field.id+"_value2");if(field_jqobj1.length>0)val1=
field_jqobj1.val();else val1=null;if(field_jqobj2.length>0)val2=field_jqobj2.val();else val2=null}else if(field.type=="select"){field_jqobj=jqobj.find("#field_"+field.id+"_value");if(field_jqobj.val()){val=field_jqobj.find("option:selected").text();val_id=field_jqobj.val()}else{val=null;val_id=null}}else if(field.type=="link"){val=field.value;val_id=field.value_id}else if(field.type=="recaptcha")val=field.value;if(val==""||val=="undefined")val=null;if(val1==""||val1=="undefined")val1=null;if(val2==
""||val2=="undefined")val2=null;if(val_id==""||val_id=="undefined")val_id=null;checkFields[field_id]={id:field_id,value:val,value1:val1,value2:val2,value_id:val_id}}}checkFields["id"]={id:"id",value:descriptor.fields["id"]["value"]};var data={fields:checkFields};if(descriptor.scrollers){data.scrollers={};for(var key in descriptor.scrollers){var scroller=descriptor.scrollers[key];data.scrollers[key]={};if(scroller.local_data.added_items){data.scrollers[key].added_items=[];var len=scroller.local_data.added_items.length;
for(var i=0;i<len;i++)if(scroller.local_data.added_items[i].fields.id.value!="-1")data.scrollers[key].added_items.push(scroller.local_data.added_items[i].fields.id.value)}if(scroller.local_data.deleted_items){data.scrollers[key].deleted_items=[];var len=scroller.local_data.deleted_items.length;for(var i=0;i<len;i++)data.scrollers[key].deleted_items.push(scroller.local_data.deleted_items[i].fields.id.value)}}}$.ajax({url:"/"+descriptor.controllerName+"/save?id="+descriptor.fields.id.value+"&check_only=1",
dataType:"json",data:JSON.stringify(data),method:"post",beforeSend:function(){},complete:function(){},success:function(json){if(!handleAjaxError(json.error))def.resolve({json:json,descriptor:descriptor})},error:function(xhr,ajaxOptions,thrownError){console.log(thrownError+"\r\n"+xhr.statusText+"\r\n"+xhr.responseText);handleAjaxError({messages:[{title:"\u041e\u0448\u0438\u0431\u043a\u0430 \u043e\u0431\u043c\u0435\u043d\u0430 \u0434\u0430\u043d\u043d\u044b\u043c\u0438",msg:"\u041e\u0448\u0438\u0431\u043a\u0430 \u043e\u0431\u0440\u0430\u0431\u043e\u0442\u043a\u0438 \u0437\u0430\u043f\u0440\u043e\u0441\u0430 \u043d\u0430 \u0441\u0442\u043e\u0440\u043e\u043d\u0435 \u0441\u0435\u0440\u0432\u0435\u0440\u0430. \u041e\u0431\u0440\u0430\u0442\u0438\u0442\u0435\u0441\u044c \u0432 \u0441\u043b\u0443\u0436\u0431\u0443 \u043f\u043e\u0434\u0434\u0435\u0440\u0436\u043a\u0438"}]});
def.reject()}})}return def}
function entityDelete(container_id,id){var scroller;var container=containers[container_id];var entity=entities[container.data.entityNameLC][id];var def=$.Deferred();if(entity.fields.id.value==-1){delete entities[container.data.entityNameLC][id];def.resolve()}else confirmDelete(container,id).done(function(){$.ajax({url:"/"+entity.entityNameLC+"/delete?id="+id,dataType:"json",method:"get",beforeSend:function(){},complete:function(){},success:function(json){if(!handleAjaxError(json.error)){handleAjaxSuccess(json.success);console.log(json);
if(container.data.type=="scroller")def.resolve();else{def.resolve();if(container.parent_container_id)hideModal(container.parent_container_id);else if(json.redirectURL)setTimeout(function(){document.location=json.redirectURL},1E3)}}else def.reject()},error:function(xhr,ajaxOptions,thrownError){console.log(thrownError+"\r\n"+xhr.statusText+"\r\n"+xhr.responseText);handleAjaxError({messages:[{title:"\u041e\u0448\u0438\u0431\u043a\u0430 \u043e\u0431\u043c\u0435\u043d\u0430 \u0434\u0430\u043d\u043d\u044b\u043c\u0438",
msg:"\u041e\u0448\u0438\u0431\u043a\u0430 \u043e\u0431\u0440\u0430\u0431\u043e\u0442\u043a\u0438 \u0437\u0430\u043f\u0440\u043e\u0441\u0430 \u043d\u0430 \u0441\u0442\u043e\u0440\u043e\u043d\u0435 \u0441\u0435\u0440\u0432\u0435\u0440\u0430. \u041e\u0431\u0440\u0430\u0442\u0438\u0442\u0435\u0441\u044c \u0432 \u0441\u043b\u0443\u0436\u0431\u0443 \u043f\u043e\u0434\u0434\u0435\u0440\u0436\u043a\u0438"}]});def.reject()}})});return def}
function entitySaveToLocalFromHTML(container_id){var descriptor=containers[container_id].data;var jqobj=containers[container_id].jqobj;if(descriptor.fields){var field,field_jqobj,val,val_id;var tmpFields={};var error={messages:[]};var errorMsg="";for(field_id in descriptor.fields){val=null,val1=null,val2=null;val_id=null;field=descriptor.fields[field_id];if(field.type!="label"&&field.id!="operations"&&field.access&&field.access=="edit"){if(field.type=="text"||field.type=="textarea"||field.type=="number"||
field.type=="email"||field.type=="password"||field.type=="date"||field.type=="amount"){field_jqobj=jqobj.find("#field_"+field.id+"_value");if(field_jqobj.length>0)val=field_jqobj.val();else val=null;if(field.type=="password"&&val!=null&&val!="")val=sha1(val)}else if(field.type=="bool"){field_jqobj=jqobj.find("#field_"+field.id+"_value");if(field_jqobj.length>0&&field_jqobj.is(":checked"))val=1;else val=0}else if(field.type=="period"){field_jqobj1=jqobj.find("#field_"+field.id+"_value1");field_jqobj2=
jqobj.find("#field_"+field.id+"_value2");if(field_jqobj1.length>0)val1=field_jqobj1.val();else val1=null;if(field_jqobj2.length>0)val2=field_jqobj2.val();else val2=null}else if(field.type=="select"){field_jqobj=jqobj.find("#field_"+field.id+"_value");if(field_jqobj.val()){val=field_jqobj.find("option:selected").text();val_id=field_jqobj.val()}else{val=null;val_id=null}}else if(field.type=="link"){val=field.value;val_id=field.value_id}else if(field.type=="recaptcha")val=field.value;if(val===""||val==
"undefined")val=null;if(val1===""||val1=="undefined")val1=null;if(val2===""||val2=="undefined")val2=null;if(val_id===""||val_id=="undefined")val_id=null;descriptor.fields[field_id].value=val;descriptor.fields[field_id].value1=val1;descriptor.fields[field_id].value2=val2;descriptor.fields[field_id].value_id=val_id}}if(descriptor.local_data.status=="actual")descriptor.local_data.status="edited";return descriptor}}
function entitySaveToServer(descriptor){var def=$.Deferred();var deferreds=[];var entityDef=$.Deferred();var container=containers[descriptor.local_data.container_id];var fields={};for(var fieldID in descriptor.fields){var field=descriptor.fields[fieldID];if(field.type!="img")fields[fieldID]={id:field["id"],value:field["value"],value1:field["value1"],value2:field["value2"],value_id:field["value_id"]}}if(descriptor.scrollers){var scrollers={};for(var fieldID in descriptor.scrollers){var scroller=descriptor.scrollers[fieldID];
scrollers[fieldID]={};if(scroller.local_data.added_items){scrollers[fieldID].added_items=[];var len=scroller.local_data.added_items.length;for(var i=0;i<len;i++)scrollers[fieldID].added_items.push(scroller.local_data.added_items[i].fields.id.value)}if(scroller.local_data.deleted_items){scrollers[fieldID].deleted_items=[];var len=scroller.local_data.deleted_items.length;for(var i=0;i<len;i++)scrollers[fieldID].deleted_items.push(scroller.local_data.deleted_items[i].fields.id.value)}}}var data={fields:fields};
if(scrollers)data.scrollers=scrollers;url="/"+descriptor.controllerName+"/save?id="+descriptor.fields.id.value;if(descriptor.local_data.mandatorySave)url+="&mandatory_save=1";$.ajax({url:url,dataType:"json",data:JSON.stringify(data),method:"post",beforeSend:function(){},complete:function(){},success:function(json){if(true){console.log(json);if(!descriptor.local_data.relationType||descriptor.local_data.relationType!="n")handleAjaxSuccess(json.success);if(!handleAjaxError(json.error)){if(json.newID){descriptor.fields.id.value=
json.newID;entities[descriptor.entityNameLC][json.newID]=entities[descriptor.entityNameLC][descriptor.local_data.eid];delete entities[descriptor.entityNameLC][descriptor.local_data.eid];descriptor.local_data.eid=json.newID}descriptor.local_data.status="actual";if(descriptor.scrollers)for(var key in descriptor.scrollers){var scroller=descriptor.scrollers[key];if(scroller.local_data.added_items){var len=scroller.local_data.added_items.length;for(var i=len-1;i>=0;i--)scroller.items.unshift(scroller.local_data.added_items[i]);
delete scroller.local_data.added_items}var len=scroller.items.length;for(var i=0;i<len;i++)scroller.items[i].local_data.status="actual";delete scroller.local_data.deleted_items;renderScroller(scroller,false)}entityDef.resolve({descriptor:descriptor,container:container})}else entityDef.reject()}else{showChecksModal({descriptor:descriptor,json:json});entityDef.reject()}},error:function(xhr,ajaxOptions,thrownError){console.log(thrownError+"\r\n"+xhr.statusText+"\r\n"+xhr.responseText);handleAjaxError({messages:[{title:"\u041e\u0448\u0438\u0431\u043a\u0430 \u043e\u0431\u043c\u0435\u043d\u0430 \u0434\u0430\u043d\u043d\u044b\u043c\u0438",
msg:"\u041e\u0448\u0438\u0431\u043a\u0430 \u043e\u0431\u0440\u0430\u0431\u043e\u0442\u043a\u0438 \u0437\u0430\u043f\u0440\u043e\u0441\u0430 \u043d\u0430 \u0441\u0442\u043e\u0440\u043e\u043d\u0435 \u0441\u0435\u0440\u0432\u0435\u0440\u0430. \u041e\u0431\u0440\u0430\u0442\u0438\u0442\u0435\u0441\u044c \u0432 \u0441\u043b\u0443\u0436\u0431\u0443 \u043f\u043e\u0434\u0434\u0435\u0440\u0436\u043a\u0438"}]});entityDef.reject()}});entityDef.done(function(data){var descriptor=data.descriptor;for(var fieldID in descriptor.fields){var field=
descriptor.fields[fieldID];if(descriptor.fields[fieldID].type=="img"&&descriptor.fields[fieldID]["access"]=="edit")if(descriptor.local_data.fields&&descriptor.local_data.fields[fieldID]){var localField=descriptor.local_data.fields[fieldID];deferreds.push(localField.deferredUpload);if(localField.deletedFiles)deferreds.push(localField.deferredDelete);if(localField.uploader.getQueuedFiles().length>0)localField.uploader.processQueue();else localField.deferredUpload.resolve()}}$.when.apply($,deferreds).done(function(){def.resolve()})});
return def}
function deleteEntityFiles(descriptor,fieldName){var dfiles;if(!descriptor.local_data.fields||!descriptor.local_data.fields[fieldName]||!descriptor.local_data.fields[fieldName].deletedFiles||descriptor.local_data.fields[fieldName].deletedFiles.length==0){if(descriptor.local_data.fields[fieldName].deferredDelete)descriptor.local_data.fields[fieldName].deferredDelete.resolve();return}dfiles=descriptor.local_data.fields[fieldName].deletedFiles;var data={files:dfiles,parent_entity_id:descriptor.local_data.eid,parent_entity_name:descriptor.entityName,
parent_entity_field:fieldName};$.when($.ajax({url:"/file/delete",dataType:"json",data:JSON.stringify(data),method:"post",beforeSend:function(){},complete:function(){},success:function(json){console.log(json);if(!handleAjaxError(json.error))delete descriptor.local_data.fields[fieldName].deletedFiles},error:function(xhr,ajaxOptions,thrownError){console.log(thrownError+"\r\n"+xhr.statusText+"\r\n"+xhr.responseText);handleAjaxError({messages:[{title:"\u041e\u0448\u0438\u0431\u043a\u0430 \u043e\u0431\u043c\u0435\u043d\u0430 \u0434\u0430\u043d\u043d\u044b\u043c\u0438",
msg:"\u041e\u0448\u0438\u0431\u043a\u0430 \u043e\u0431\u0440\u0430\u0431\u043e\u0442\u043a\u0438 \u0437\u0430\u043f\u0440\u043e\u0441\u0430 \u043d\u0430 \u0441\u0442\u043e\u0440\u043e\u043d\u0435 \u0441\u0435\u0440\u0432\u0435\u0440\u0430. \u041e\u0431\u0440\u0430\u0442\u0438\u0442\u0435\u0441\u044c \u0432 \u0441\u043b\u0443\u0436\u0431\u0443 \u043f\u043e\u0434\u0434\u0435\u0440\u0436\u043a\u0438"}]})}})).done(function(){descriptor.local_data.fields[fieldName].deferredDelete.resolve()}).fail(function(){descriptor.local_data.fields[fieldName].deferredDelete.reject()})}
;function initModalScripts(container_id){containers[container_id].jqobj.on("hidden.bs.modal",function(e){closeModal(container_id)})}function hideModal(container_id){containers[container_id].jqobj.modal("hide")}function showModal(container_id){containers[container_id].jqobj.modal("show");$.notifyClose()}
function closeModal(container_id){var container=containers[container_id];delete containers[container.data.local_data.container_id];delete container.data.local_data.target_container_id;if(container.data.scrollers)for(var key in container.data.scrollers){var sld=container.data.scrollers[key].local_data;delete containers[sld.container_id]}delete container.data.local_data.container_id;container.jqobj.remove();delete containers[container_id]}
function renderModal(descriptor,targetContainer){var modal_container_id=createUDID();descriptor.local_data.container_id=createUDID(descriptor);if(targetContainer)descriptor.local_data.target_container_id=targetContainer.data.local_data.container_id;return{dfd:$.when(getTemplateByName("modal_template"),getTemplate(descriptor)).done(function(data,data2){var html=data.tmpl.render({descriptor:descriptor,tmplName:data2.tmplName,modal_container_id:modal_container_id});$("#container_modals").append(html);
containers[modal_container_id]={jqobj:$("#container_modals").find("#"+modal_container_id),data:descriptor};if(descriptor.type=="entity"){containers[descriptor.local_data.container_id]={jqobj:containers[modal_container_id].jqobj.find("#"+descriptor.local_data.container_id),data:descriptor,parent_container_id:modal_container_id};renderEntityScrollers(descriptor);initEntityScripts(descriptor.local_data.container_id)}else if(descriptor.type=="scroller"){containers[descriptor.local_data.container_id]=
{jqobj:containers[modal_container_id].jqobj.find("#"+descriptor.local_data.container_id),data:descriptor,parent_container_id:modal_container_id};initScrollerScripts(descriptor.local_data.container_id)}initModalScripts(modal_container_id)}),container_id:modal_container_id}}
function linkSelectedRows(source_container_id){var sContainer=containers[source_container_id];var tContainer=containers[sContainer.data.local_data.target_container_id];var tScroller;var entity;var rows=sContainer.jqobj.find("tbody input[name^='row_']:checked");selectTarget=tContainer.data.local_data.selectTarget;tData=tContainer.data;if(tContainer.data.type=="entity"){if(selectTarget.field_id)var tField=tData.fields[selectTarget.field_id];else return;if(rows.length==1){var name=rows[0].id;var entity_id=
name.substring(4,name.length);entity=entities[sContainer.data.entityNameLC][entity_id];console.log(entity);tField.value_id=entity.fields.id.value;tField.value=entity.fields[tField.field].value;tField.entity=entity}else if(rows.length==0){console.log("\u0412 \u0441\u043a\u0440\u043e\u043b\u043b\u0435\u0440\u0435 \u043d\u0438\u0447\u0435\u0433\u043e \u043d\u0435 \u0432\u044b\u0431\u0440\u0430\u043d\u043e");tField.value_id=null;tField.value=null}else{console.log("\u0412 \u0441\u043a\u0440\u043e\u043b\u043b\u0435\u0440\u0435 \u0432\u044b\u0431\u0440\u0430\u043d\u044b \u0434\u0432\u0435 \u0438\u043b\u0438 \u0431\u043e\u043b\u0435\u0435 \u0437\u0430\u043f\u0438\u0441\u0435\u0439");
tField.value_id=null;tField.value=null}tData.local_data.status="edited";var tmpl=$.templates[tData.actionName+"_entity_field_"+tField.type];var html=tmpl.render(tField);var jqf=tContainer.jqobj.find("[id='field_"+tField.id+"_value']").parent();jqf.replaceWith(html);hideModal(sContainer.parent_container_id)}else if(tContainer.data.type=="scroller"){var rowsLength=rows.length;if(rowsLength>0){for(var i=0;i<rowsLength;i++){var name=rows[i].id;var entity_id=name.substring(4,name.length);console.log(entities[sContainer.data.entityNameLC][entity_id]);
tScroller=tContainer.data;addItemToScroller(entities[sContainer.data.entityNameLC][entity_id],tScroller,{confirmFromServer:false})}$.when(getTemplate(tScroller)).done(function(data){var html=data.tmpl.render({descriptor:tScroller});tContainer.jqobj.html(html)})}hideModal(sContainer.parent_container_id)}}
var modalModule=function(app){var modal\u0421ontainers={};var body=document.getElementsByTagName("body");function initModalScripts(containerID){modal\u0421ontainers[containerID].jqobj.on("hidden.bs.modal",function(e){closeModal(containerID)})}function hideModal(containerID){$(modal\u0421ontainers[containerID].dom).modal("hide")}function showModal(containerID){$.notifyClose();$(modal\u0421ontainers[containerID].dom).modal("show")}function closeModal(containerID){var modalContainer=modal\u0421ontainers[containerID];
delete containers[modalContainer.data.local_data.containerID];if(modalContainer.data.scrollers)for(var key in modalContainer.data.scrollers)delete containers[modalContainer.data.scrollers[key].local_data.containerID];modalContainer.dom.parentNode.removeChild(modalContainer.dom);delete modal\u0421ontainers[containerID]}function renderModal(descriptor,targetContainer,afterRenderCallback){var modalContainerID=createUDID();descriptor.local_data.container_id=createUDID(descriptor);if(targetContainer)descriptor.local_data.target_container_id=
targetContainer.data.local_data.container_id;var dfd=$.when(getTemplateByName("modal_template"),getTemplate(descriptor)).done(function(data,data2){var html=data.tmpl.render({descriptor:descriptor,tmplName:data2.tmplName,modal_container_id:modalContainerID});body.innerHTML+=html;modal\u0421ontainers[modalContainerID]={dom:document.getElementsById(modalContainerID),data:descriptor};containers[descriptor.local_data.container_id]={dom:document.getElementsById(descriptor.local_data.container_id),data:descriptor,
parent_container_id:modalContainerID};afterRenderCallback();initModalScripts(modalContainerID);showModal(modalContainerID)});return{dfd:dfd,container_id:modal_container_id}}return{initModalScripts:initModalScripts,hideModal:hideModal,showModal:showModal,closeModal:closeModal,renderModal:renderModal}}(app);
(function($,window){var MultiModal=function(element){this.$element=$(element);this.modalCount=0};MultiModal.BASE_ZINDEX=1040;MultiModal.prototype.show=function(target){var that=this;var $target=$(target);var modalIndex=that.modalCount++;$target.css("z-index",MultiModal.BASE_ZINDEX+modalIndex*20+10);window.setTimeout(function(){if(modalIndex>0)$(".modal-backdrop").not(":first").addClass("hidden");that.adjustBackdrop()})};MultiModal.prototype.hidden=function(target){this.modalCount--;if(this.modalCount){this.adjustBackdrop();
$("body").addClass("modal-open")}};MultiModal.prototype.adjustBackdrop=function(){var modalIndex=this.modalCount-1;$(".modal-backdrop:first").css("z-index",MultiModal.BASE_ZINDEX+modalIndex*20)};function Plugin(method,target){return this.each(function(){var $this=$(this);var data=$this.data("multi-modal-plugin");if(!data)$this.data("multi-modal-plugin",data=new MultiModal(this));if(method)data[method](target)})}$.fn.multiModal=Plugin;$.fn.multiModal.Constructor=MultiModal;$(document).on("show.bs.modal",
function(e){$(document).multiModal("show",e.target)});$(document).on("hidden.bs.modal",function(e){$(document).multiModal("hidden",e.target)})})(jQuery,window);function initScrollerScripts(container_id){var container=containers[container_id];var toggleAll=container.jqobj.find("input.toggle-all:not(:has(.inited))");toggleAll.on("change",function(){containers[container_id].jqobj.find("input[name^='row_scroller']").each(function(indx,element){$(this).prop("checked",$("#"+container_id+" input.toggle-all[name='"+container_id+"']").prop("checked"))})});toggleAll.addClass("inited");container.jqobj.find(".panel-heading[data-toggle='collapse']").each(function(indx,
element){$(this).on("click",function(e){var icon=$(this).find("i");if(icon.hasClass("glyphicon-minus"))icon.removeClass("glyphicon-minus").addClass("glyphicon-plus");else icon.removeClass("glyphicon-plus").addClass("glyphicon-minus")})});container.jqobj.find("input[name^='filter_']:not(:has(.inited))").each(function(indx,element){$(this).focusin(function(){$(this).bind("keypress",function(e){if(e.keyCode==13)apply_filter(container_id)})}).focusout(function(){$(this).unbind("keypress",false)}).addClass("inited")});
container.jqobj.find("tr.status-actual").each(function(indx,element){var obj=$(this);setTimeout(function(){obj.removeClass("status-actual success")},2E3)});if($.fn.select2){$.fn.select2.defaults.set("theme","bootstrap");$("select.extended").select2()}container.jqobj.find("select[name^='filter_']").each(function(indx,element){$(this).bind("change",function(e){apply_filter(container_id)})})}
function row_show(container_id,id){var container=containers[container_id];var scroller=container.data;url="/"+scroller.entityNameLC+"/show"+(id?"?id="+id:"");if(scroller.edit_style=="url")document.location=url;else if(scroller.edit_style=="modal"){if(entities[scroller.entityNameLC]&&entities[scroller.entityNameLC][id]){if(containers[entities[scroller.entityNameLC][id].local_data.container_id]){alert("\u0421\u0443\u0449\u043d\u043e\u0441\u0442\u044c \u0443\u0436\u0435 \u043e\u0442\u043a\u0440\u044b\u0442\u0430 \u043d\u0430 \u0440\u0435\u0434\u0430\u043a\u0442\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0435 \u0432 \u0434\u0440\u0443\u0433\u043e\u0439 \u044d\u043a\u0440\u0430\u043d\u043d\u043e\u0439 \u0444\u043e\u0440\u043c\u0435. \u0417\u0430\u0432\u0435\u0440\u0448\u0438\u0442\u0435 \u0440\u0430\u0431\u043e\u0442\u0443 \u0441 \u0434\u0438\u0430\u043b\u043e\u0433\u0430\u043c\u0438 \u0438 \u0432\u0435\u0440\u043d\u0438\u0442\u0435\u0441\u044c \u043a \u0440\u0435\u0434\u0430\u043a\u0442\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u044e \u0441\u0443\u0449\u043d\u043e\u0441\u0442\u0438");
return}if(entities[scroller.entityNameLC][id].fields.id.value==-1||entities[scroller.entityNameLC][id].fields.id.value!=-1&&entities[scroller.entityNameLC][id].local_data.status!="actual"){var renderData=renderModal(entities[scroller.entityNameLC][id],container);renderData.dfd.done(function(data){showModal(renderData.container_id)});return}}$.ajax({url:url,dataType:"json",method:"get",beforeSend:function(){},complete:function(){},success:function(json){if(!handleAjaxError(json.error)){console.log(json);
var local_entity=saveFullServerEntity(json);if(scroller.relationType)local_entity.local_data.relationType=scroller.relationType;initEntityScrollers(local_entity);var renderData=renderModal(local_entity,container);renderData.dfd.done(function(data){showModal(renderData.container_id)})}},error:function(xhr,ajaxOptions,thrownError){console.log(thrownError+"\r\n"+xhr.statusText+"\r\n"+xhr.responseText);handleAjaxError({messages:[{title:"\u041e\u0448\u0438\u0431\u043a\u0430 \u043e\u0431\u043c\u0435\u043d\u0430 \u0434\u0430\u043d\u043d\u044b\u043c\u0438",
msg:"\u041e\u0448\u0438\u0431\u043a\u0430 \u043e\u0431\u0440\u0430\u0431\u043e\u0442\u043a\u0438 \u0437\u0430\u043f\u0440\u043e\u0441\u0430 \u043d\u0430 \u0441\u0442\u043e\u0440\u043e\u043d\u0435 \u0441\u0435\u0440\u0432\u0435\u0440\u0430. \u041e\u0431\u0440\u0430\u0442\u0438\u0442\u0435\u0441\u044c \u0432 \u0441\u043b\u0443\u0436\u0431\u0443 \u043f\u043e\u0434\u0434\u0435\u0440\u0436\u043a\u0438"}]})}})}else alert("\u0417\u0430\u043f\u0440\u043e\u0448\u0435\u043d \u043f\u0440\u043e\u0441\u043c\u043e\u0442\u0440 \u0441\u0443\u0449\u043d\u043e\u0441\u0442\u0438 \u0441 \u043d\u0435\u0438\u0437\u0432\u0435\u0441\u0442\u043d\u044b\u043c scroller.edit_style")}
function row_edit(container_id,id){var container=containers[container_id];var scroller=container.data;url="/"+scroller.entityNameLC+"/edit"+(id?"?id="+id:"");if(scroller.edit_style=="url")document.location=url;else if(scroller.edit_style=="modal"){if(entities[scroller.entityNameLC]&&entities[scroller.entityNameLC][id]){if(containers[entities[scroller.entityNameLC][id].local_data.container_id]){alert("\u0421\u0443\u0449\u043d\u043e\u0441\u0442\u044c \u0443\u0436\u0435 \u043e\u0442\u043a\u0440\u044b\u0442\u0430 \u043d\u0430 \u0440\u0435\u0434\u0430\u043a\u0442\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0435 \u0432 \u0434\u0440\u0443\u0433\u043e\u0439 \u044d\u043a\u0440\u0430\u043d\u043d\u043e\u0439 \u0444\u043e\u0440\u043c\u0435. \u0417\u0430\u0432\u0435\u0440\u0448\u0438\u0442\u0435 \u0440\u0430\u0431\u043e\u0442\u0443 \u0441 \u0434\u0438\u0430\u043b\u043e\u0433\u0430\u043c\u0438 \u0438 \u0432\u0435\u0440\u043d\u0438\u0442\u0435\u0441\u044c \u043a \u0440\u0435\u0434\u0430\u043a\u0442\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u044e \u0441\u0443\u0449\u043d\u043e\u0441\u0442\u0438");
return}if(entities[scroller.entityNameLC][id].fields.id.value==-1||entities[scroller.entityNameLC][id].fields.id.value!=-1&&entities[scroller.entityNameLC][id].local_data.status!="actual"){var renderData=renderModal(entities[scroller.entityNameLC][id],container);renderData.dfd.done(function(data){showModal(renderData.container_id)});return}}$.ajax({url:url,dataType:"json",method:"get",beforeSend:function(){},complete:function(){},success:function(json){if(!handleAjaxError(json.error)){console.log(json);
var local_entity=saveFullServerEntity(json);if(scroller.relationType)local_entity.local_data.relationType=scroller.relationType;initEntityScrollers(local_entity);var renderData=renderModal(local_entity,container);renderData.dfd.done(function(data){showModal(renderData.container_id)})}},error:function(xhr,ajaxOptions,thrownError){console.log(thrownError+"\r\n"+xhr.statusText+"\r\n"+xhr.responseText);handleAjaxError({messages:[{title:"\u041e\u0448\u0438\u0431\u043a\u0430 \u043e\u0431\u043c\u0435\u043d\u0430 \u0434\u0430\u043d\u043d\u044b\u043c\u0438",
msg:"\u041e\u0448\u0438\u0431\u043a\u0430 \u043e\u0431\u0440\u0430\u0431\u043e\u0442\u043a\u0438 \u0437\u0430\u043f\u0440\u043e\u0441\u0430 \u043d\u0430 \u0441\u0442\u043e\u0440\u043e\u043d\u0435 \u0441\u0435\u0440\u0432\u0435\u0440\u0430. \u041e\u0431\u0440\u0430\u0442\u0438\u0442\u0435\u0441\u044c \u0432 \u0441\u043b\u0443\u0436\u0431\u0443 \u043f\u043e\u0434\u0434\u0435\u0440\u0436\u043a\u0438"}]})}})}else alert("\u0417\u0430\u043f\u0440\u043e\u0448\u0435\u043d\u043e \u0441\u043e\u0437\u0434\u0430\u043d\u0438\u0435/\u0440\u0435\u0434\u0430\u043a\u0442\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0435 \u0441\u0443\u0449\u043d\u043e\u0441\u0442\u0438 \u0441 \u043d\u0435\u0438\u0437\u0432\u0435\u0441\u0442\u043d\u044b\u043c scroller.edit_style")}
function row_delete(container_id,id){container=containers[container_id];var scroller=containers[container_id].data;var entity=entities[scroller.entityNameLC][id];if(!container.parent_container_id)entityDelete(container_id,id).done(function(){deleteItemFromScroller(entity,scroller,{confirmFromServer:true});renderScroller(scroller,false)});else{deleteItemFromScroller(entities[scroller.entityNameLC][id],scroller,{confirmFromServer:false});renderScroller(scroller,false)}}
function apply_filter(container_id){var container=containers[container_id];var data=container.data;var udid=data.local_data.udid;var jqobj=container.jqobj;var rq={};var controllerName=data.controllerName;url="/"+controllerName+"/index";if(container.parent_container_id){var parentData=containers[container.parent_container_id].data;if(parentData.type==="entity"){rq.scrollerName=controllerName;rq.actionName=parentData.actionName;controllerName=parentData.controllerName;url="/"+controllerName+"/filter"}}var page=
jqobj.find("#page").val();rq.page=encodeURIComponent(page?page:1);var sort=jqobj.find("#sort").val();if(sort)rq.sort=encodeURIComponent(sort);var order=jqobj.find("#order").val();if(order)rq.order=encodeURIComponent(order);var page_size=jqobj.find("select[name='page_sizes']").val();if(page_size)rq.page_size=encodeURIComponent(page_size);var tr_offs=data.group_operations&&data.group_operations.length>0||data.common_operations&&data.common_operations.length>0?2:1;var columns=jqobj.find("table tr:eq("+
tr_offs+") td");var columns_length=columns.length;for(var i=0;i<columns_length;i++){var field=columns.eq(i).find("input[name^='filter_']").filter("[type='text'], [type='number'], [type='email']");if(field.val())rq[field.attr("name")]=encodeURIComponent(field.val());else{field=columns.eq(i).find("select[name^='filter_']");if(field.val()&&field.val()=="**")rq[field.attr("name")]=encodeURIComponent(field.val());else if(field.val()&&field.val()!="*")rq[field.attr("name")]=encodeURIComponent(field.val());
else;}}if(data.add_filter){rq.add_filter={};for(var key in data.add_filter)rq.add_filter[key]=data.add_filter[key]}if(data.filter_values.exclude_ids)rq.exclude_ids=data.filter_values.exclude_ids;if(typeof static_filter_values!=="undefined")for(var key in static_filter_values)rq[key]=static_filter_values[key];console.log(url);var rqDefferred=$.ajax({url:url,data:rq,dataType:"json",method:"post",beforeSend:function(){setTimeout(function(){if(rqDefferred.state()=="pending"){var blockedJQ=$("#"+container_id+
"CollapseDiv");var spinnerJQ=blockedJQ.find("#spinner");if(spinnerJQ.length==0)blockedJQ.prepend('<div id="spinner" class="LockOn"><button class="btn btn-default center-block"><span class="glyphicon glyphicon-refresh glyphicon-refresh-animate"></span> \u041e\u0431\u0440\u0430\u0431\u043e\u0442\u043a\u0430 \u0437\u0430\u043f\u0440\u043e\u0441\u0430</button></div>');else{spinnerJQ.removeClass("LockOff");spinnerJQ.addClass("LockOn")}spinnerJQ.height(blockedJQ.height())}},500)},complete:function(){clearTimeout(jqobj.data.timeoutID);
var blockedJQ=$("#"+container_id+"CollapseDiv");var spinnerJQ=blockedJQ.find("#spinner");spinnerJQ.removeClass("LockOn");spinnerJQ.addClass("LockOff")},success:function(json){if(!handleAjaxError(json.error)){console.log(json);var add_style=this.data.add_style;copyDescriptor(json,this.data);this.data.add_style=add_style;var isFound=false;var len;if(this.data.local_data.added_items){len=this.data.local_data.added_items.length;for(var i=0;i<len;i++){var item=this.data.local_data.added_items[i];var itemsLen=
this.data.items.length;for(var j=0;j<itemsLen;j++)if(item.fields.id.value==this.data.items[j].fields.id.value){this.data.local_data.added_items.items.splice(i,1);isFound=true;break}}}if(this.data.local_data.deleted_items&&!isFound){len=data.items.length;for(var i=0;i<len;i++){var item=this.data.local_data.deleted_items[i];var itemsLen=this.data.items.length;for(var j=0;j<itemsLen;j++)if(item.fields.id.value==this.data.items[j].fields.id.value){this.data.items.splice(i,1);break}}}saveScrollerItems(this.data);
renderScroller(this.data,false)}}.bind(container),error:function(xhr,ajaxOptions,thrownError){console.log(thrownError+"\r\n"+xhr.statusText+"\r\n"+xhr.responseText);handleAjaxError({messages:[{title:"\u041e\u0448\u0438\u0431\u043a\u0430 \u043e\u0431\u043c\u0435\u043d\u0430 \u0434\u0430\u043d\u043d\u044b\u043c\u0438",msg:"\u041e\u0448\u0438\u0431\u043a\u0430 \u043e\u0431\u0440\u0430\u0431\u043e\u0442\u043a\u0438 \u0437\u0430\u043f\u0440\u043e\u0441\u0430 \u043d\u0430 \u0441\u0442\u043e\u0440\u043e\u043d\u0435 \u0441\u0435\u0440\u0432\u0435\u0440\u0430. \u041e\u0431\u0440\u0430\u0442\u0438\u0442\u0435\u0441\u044c \u0432 \u0441\u043b\u0443\u0436\u0431\u0443 \u043f\u043e\u0434\u0434\u0435\u0440\u0436\u043a\u0438"}]})}})}
function change_page(container_id,p){console.log("p="+p);containers[container_id].jqobj.find("#page").val(p);console.log("page="+containers[container_id].jqobj.find("#page").val());apply_filter(container_id)}function change_sort(container_id,id){var order=containers[container_id].jqobj.find("#order");var sort=containers[container_id].jqobj.find("#sort");if(sort.val()==id)order.val()=="desc"?order.val("asc"):order.val("desc");else sort.val(id);apply_filter(container_id)}
function change_page_size(container_id){containers[container_id].jqobj.find("#page_size").val(containers[container_id].jqobj.find("select[name='page_sizes']").val());apply_filter(container_id)}
function clear_filter(container_id){var data=containers[container_id].data;var tr_offs=data.group_operations&&data.group_operations.length>0?2:1;var columns=containers[container_id].jqobj.find("#"+createUDID(data)+" table tr:eq("+tr_offs+") td");for(var i=0;i<columns.length;i++)columns.eq(i).find("input[name^='filter_'], select[name^='filter_']").each(function(){$(this).val("")});apply_filter(container_id)}
function addCSSClassFix(element,cssClass){var currentClassStr="";if(element.classList)currentClassStr=element.classList;else currentClassStr=element.className;var CSSClasses=cssClass.split(" ");var CSSClassesLength=CSSClasses.length;for(var i=0;i<CSSClassesLength;i++)if(element.classList)element.classList.add(CSSClasses[i]);else if(!currentClassStr.indexOf(CSSClasses[i])!==-1)element.className+=" "+CSSClasses[i]}
function deleteCSSClassFix(element,cssClass){var currentClassStr="";if(element.classList)currentClassStr=element.classList;else currentClassStr=element.className;var CSSClasses=cssClass.split(" ");var CSSClassesLength=CSSClasses.length;if(element.classList)for(var i=0;i<CSSClassesLength;i++)element.classList.remove(CSSClasses[i]);else for(var i=0;i<CSSClassesLength;i++){var regexp=new RegExp(CSSClasses[i],"g");currentClassStr.replace(regexp,"")}if(!element.classList)element.className=currentClassStr;
var currentClassStr="";if(element.hasAttribute("class"))currentClassStr=element.getAttribute("class");var CSSClasses=cssClass.split(" ");var CSSClassesLength=CSSClasses.length;for(var i=0;i<CSSClassesLength;i++){var regexp=new RegExp(CSSClasses[i],"g");currentClassStr.replace(regexp,"")}element.setAttribute("class",currentClassStr)}
function toggleScrollerFilter(containerID,fieldID,command,onof){var toggleBtnID=containerID+"_filter_"+fieldID+"_empty_toggle_btn";var emptyBtnID=containerID+"_filter_"+fieldID+"_empty_btn";var notEmptyBtnID=containerID+"_filter_"+fieldID+"_notempty_btn";var toggleBtn=document.getElementById(toggleBtnID);var emptyBtn=document.getElementById(emptyBtnID);var notEmptyBtn=document.getElementById(notEmptyBtnID);var inputFld=toggleBtn.parentNode.parentNode.getElementsByTagName("input")[0];if(command=="empty")if(onof){addCSSClassFix(notEmptyBtn,
"hidden");deleteCSSClassFix(emptyBtn,"hidden");inputFld.value="";inputFld.disabled=true}else{addCSSClassFix(emptyBtn,"hidden");addCSSClassFix(notEmptyBtn,"hidden");inputFld.disabled=false}else if(command=="notempty")if(onof){addCSSClassFix(emptyBtn,"hidden");deleteCSSClassFix(notEmptyBtn,"hidden");inputFld.value="";inputFld.disabled=true}else{addCSSClassFix(emptyBtn,"hidden");addCSSClassFix(notEmptyBtn,"hidden");inputFld.disabled=false}};
